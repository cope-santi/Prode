<!DOCTYPE html>
<html lang="es" dir="ltr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Admin - Mundial 2026</title>
    <meta name="title" content="Panel Admin - Mundial 2026" />
    <meta name="description" content="Panel admin para gestionar partidos del Mundial 2026" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="icon" href="./css/icon/favicon-ball.ico" />

    <script src="https://kit.fontawesome.com/e32607c50a.js" crossorigin="anonymous"></script>
</head>

<body>
    <header id="app-navbar"></header>

    <!-- Header Section -->
    <section class="hero-image-section py-2">
        <div class="hero-image-container">
            <img src="css/images/bg3.jpg" class="img-fluid bg-img" alt="background-image">
        </div>
    </section>

    <!-- Admin Panel -->
    <section class="py-5">
        <div class="container">
            <div class="app-card prediction-section">
                <h1 class="mb-4">Panel Admin</h1>

                <!-- Auth UI -->
                <div id="auth-ui" class="mb-4">
                    <div id="login-register-form">
                        <div class="row">
                            <div class="col-md-6 offset-md-3">
                                <h3 class="mb-3">Ingreso admin</h3>
                                <div class="form-group mb-3">
                                    <label for="userEmail">Correo:</label>
                                    <input type="email" id="userEmail" class="form-control" placeholder="Ingresa tu correo" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="userPassword">Contraseña:</label>
                                    <input type="password" id="userPassword" class="form-control" placeholder="Ingresa tu contraseña" required>
                                    <div class="text-right mt-1">
                                        <a href="#" id="forgotPasswordLink" class="text-muted small">¿Olvidaste tu contraseña?</a>
                                    </div>
                                </div>
                                <button id="signInButton" type="button" class="btn btn-success">Entrar</button>
                                <p id="auth-message" class="text-danger mt-3" style="font-weight: bold;"></p>
                            </div>
                        </div>
                    </div>

                    <div id="user-status-display" style="display: none;">
                        <div class="alert alert-info">
                            <p>Bienvenido, <span id="userNameDisplay" style="font-weight: bold;"></span>!</p>
                            <p>Sesión iniciada con: <span id="userEmailDisplay" style="font-weight: bold;"></span></p>
                            <button id="signOutButton" class="btn btn-danger mt-2">Salir</button>
                        </div>
                    </div>
                </div>

                <!-- Admin Game Form Section -->
                <div id="admin-game-form-section" style="display: none;">
                    <h2 class="mb-4">Agregar partido del Mundial 2026</h2>

                    <!-- Manual Form Entry -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminHomeTeam">Equipo local:</label>
                                <input type="text" id="adminHomeTeam" class="form-control" placeholder="Nombre del equipo" list="teamNamesList">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminAwayTeam">Equipo visitante:</label>
                                <input type="text" id="adminAwayTeam" class="form-control" placeholder="Nombre del equipo" list="teamNamesList">
                            </div>
                        </div>
                    </div>

                    <!-- Datalist for team autocomplete -->
                    <datalist id="teamNamesList"></datalist>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminStage">Fase:</label>
                                <select id="adminStage" class="form-control"></select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminGroup">Grupo (A-L):</label>
                                <select id="adminGroup" class="form-control"></select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminMatchday">Jornada (1-3):</label>
                                <select id="adminMatchday" class="form-control"></select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminKickOffTime">Horario:</label>
                                <input type="datetime-local" id="adminKickOffTime" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminStatus">Estado:</label>
                                <select id="adminStatus" class="form-control">
                                    <option value="upcoming">Proximo</option>
                                    <option value="finished">Finalizado</option>
                                    <option value="live">En vivo</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="adminManualOverride">
                            <label class="form-check-label" for="adminManualOverride">
                                Forzar manual (sin sobrescribir por sync)
                            </label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminHomeScore">Goles local (opcional):</label>
                                <input type="number" id="adminHomeScore" class="form-control" min="0" placeholder="Ej: 2">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="adminAwayScore">Goles visitante (opcional):</label>
                                <input type="number" id="adminAwayScore" class="form-control" min="0" placeholder="Ej: 1">
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="addGameButton" type="button" class="btn btn-primary-custom btn-lg">Agregar partido</button>
                    </div>
                    <hr class="my-4">
                    <h4 class="mb-3">Editar partido existente</h4>
                    <div class="form-group mb-3">
                        <label for="adminGameSelect">Selecciona partido:</label>
                        <select id="adminGameSelect" class="form-control"></select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <button id="loadGameButton" type="button" class="btn btn-outline-info btn-block">Cargar seleccionado</button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button id="updateGameButton" type="button" class="btn btn-warning btn-block">Actualizar partido</button>
                        </div>
                    </div>
                    <p id="gameMessage" class="mt-3 text-center"></p>

                    <hr class="my-5">
                    <h2 class="mb-3">Participantes</h2>
                    <p class="text-muted small">Lista basada en las predicciones guardadas.</p>
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                        <button id="refreshParticipantsButton" type="button" class="btn btn-outline-light btn-sm">Actualizar</button>
                        <span id="admin-participants-count" class="text-muted small"></span>
                    </div>
                    <div id="admin-participants-list" class="game-list">
                        <p class="text-center text-muted">Cargando participantes...</p>
                    </div>
                    <p id="admin-participants-message" class="mt-3 text-center"></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <div class="footer-container">
        <a href="https://chat.whatsapp.com/2cUguIQ8AWhCTkfYLaixfi" target="_blank"><i class="footer-icon fab fa-whatsapp fa-2x"></i></a>
        <p class='footer-link'>© <span id="admin-footer-year"></span> José Daniel Cuéllar Lobo.</p>
    </div>

    <script type="module">
        import { mountNavbar } from "./js/layout.js";
        // Import the functions you need from the SDKs you want to use
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, query, orderBy, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        // Import Authentication functions
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // Import centralized Firebase configuration
        import { firebaseConfig } from "./js/firebase-config.js";
        // Import admin panel module
        import { initializeAdminPanel, toggleAdminForm, populateAdminDropdowns, populateTeamDatalist, populateAdminGameSelect } from "./js/admin-panel.js";
        import { TOURNAMENT_CONFIG } from "./js/tournament-config.js";

        mountNavbar({ activeKey: "admin" });
        document.getElementById('admin-footer-year').textContent = new Date().getFullYear();

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        console.log("Firebase initialized in admin.html");
        console.log("Current auth user:", auth.currentUser ? auth.currentUser.email : "Not signed in");

        // Initialize admin panel module
        initializeAdminPanel(db, addDoc, collection, updateDoc, doc);

        // DOM References for Auth
        const loginRegisterFormDiv = document.getElementById('login-register-form');
        const userStatusDisplayDiv = document.getElementById('user-status-display');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const signOutButton = document.getElementById('signOutButton');
        const userEmailInput = document.getElementById('userEmail');
        const userPasswordInput = document.getElementById('userPassword');
        const signInButton = document.getElementById('signInButton');
        const authMessageDiv = document.getElementById('auth-message');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const adminGameFormSection = document.getElementById('admin-game-form-section');
        const adminParticipantsList = document.getElementById('admin-participants-list');
        const adminParticipantsMessage = document.getElementById('admin-participants-message');
        const adminParticipantsCount = document.getElementById('admin-participants-count');
        const refreshParticipantsButton = document.getElementById('refreshParticipantsButton');

        // Global data
        let currentUserId = null;
        let currentUserEmail = null;
        let allTeams = [];
        // ADMIN_UID - Must match the value in index.html
        const ADMIN_UID = 'eP44roQf40ZOgh0rZYnsh91y7vI3'; // Same UID as in index.html

        /**
         * Initialize admin dropdowns - Fetch teams from Firestore
         */
        async function initializeAdminDropdowns() {
            console.log("initializeAdminDropdowns called");
            try {
                // Fetch Teams from Firestore
                const teamsRef = collection(db, 'teams');
                const teamsSnapshot = await getDocs(query(teamsRef, orderBy('name')));
                allTeams = [];
                teamsSnapshot.forEach(doc => {
                    allTeams.push({ id: doc.id, ...doc.data() });
                });
                console.log("Fetched teams from Firestore:", allTeams.map(t => t.name));

                // Call module function to populate dropdowns
                try {
                    await populateAdminDropdowns();
                    console.log("Admin dropdowns populated successfully");

                    // Also populate team datalist for autocomplete
                    console.log("Calling populateTeamDatalist with team names:", allTeams.map(t => t.name));
                    populateTeamDatalist(allTeams.map(t => t.name));
                    console.log("Team datalist populated successfully");

                    const gamesRef = collection(db, 'games');
                    const gamesSnapshot = await getDocs(query(
                        gamesRef,
                        where('tournamentId', '==', TOURNAMENT_CONFIG.tournamentId)
                    ));
                    const games = [];
                    gamesSnapshot.forEach(docSnapshot => {
                        games.push({ id: docSnapshot.id, ...docSnapshot.data() });
                    });
                    games.sort((a, b) => {
                        const timeA = a.KickOffTime ? new Date(a.KickOffTime).getTime() : 0;
                        const timeB = b.KickOffTime ? new Date(b.KickOffTime).getTime() : 0;
                        return timeA - timeB;
                    });
                    populateAdminGameSelect(games);
                } catch (dropdownError) {
                    console.error("Error populating admin dropdowns:", dropdownError);
                    authMessageDiv.textContent = `Error loading admin data: ${dropdownError.message}`;
                    authMessageDiv.style.color = 'red';
                }

            } catch (error) {
                console.error("Error initializing admin dropdowns:", error);
            }
        }

        function setParticipantsMessage(message, isError = false) {
            if (!adminParticipantsMessage) return;
            adminParticipantsMessage.textContent = message;
            adminParticipantsMessage.style.color = isError ? 'red' : 'inherit';
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const rawValue = timestamp.toDate ? timestamp.toDate() : timestamp;
            const parsed = new Date(rawValue);
            if (Number.isNaN(parsed.getTime())) return '';
            return parsed.toLocaleString();
        }

        async function loadParticipants() {
            if (!adminParticipantsList) return;
            adminParticipantsList.innerHTML = '<p class="text-center text-muted">Cargando participantes...</p>';
            setParticipantsMessage('');

            try {
                const predictionsRef = collection(db, 'predictions');
                const q = query(
                    predictionsRef,
                    where('tournamentId', '==', TOURNAMENT_CONFIG.tournamentId)
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    adminParticipantsList.innerHTML = '<p class="text-center text-muted">No hay participantes todavia.</p>';
                    if (adminParticipantsCount) {
                        adminParticipantsCount.textContent = '0 participantes';
                    }
                    return;
                }

                const participantsMap = new Map();
                snapshot.forEach(docSnap => {
                    const prediction = docSnap.data();
                    const userId = prediction.userId;
                    if (!userId) return;

                    const timestamp = prediction.timestamp ? new Date(prediction.timestamp.toDate ? prediction.timestamp.toDate() : prediction.timestamp).getTime() : 0;
                    const existing = participantsMap.get(userId);
                    const count = existing ? existing.count + 1 : 1;
                    let playerName = prediction.playerName || 'Anonimo';
                    let userEmail = prediction.userEmail || '';
                    let latestTimestamp = timestamp;

                    if (existing) {
                        if (existing.timestamp >= timestamp) {
                            playerName = existing.playerName;
                            userEmail = existing.userEmail || userEmail;
                            latestTimestamp = existing.timestamp;
                        }
                    }

                    participantsMap.set(userId, {
                        userId,
                        playerName,
                        userEmail,
                        timestamp: latestTimestamp,
                        count
                    });
                });

                const participants = Array.from(participantsMap.values()).sort((a, b) => b.timestamp - a.timestamp);
                if (adminParticipantsCount) {
                    adminParticipantsCount.textContent = `${participants.length} participantes`;
                }

                adminParticipantsList.innerHTML = '';
                participants.forEach(participant => {
                    const card = document.createElement('div');
                    card.className = 'app-card participant-card d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3';
                    const emailLabel = participant.userEmail ? participant.userEmail : 'Sin correo';
                    const lastUpdate = formatTimestamp(participant.timestamp);
                    card.innerHTML = `
                        <div>
                            <h5 class="mb-1">${participant.playerName || 'Anonimo'}</h5>
                            <div class="text-muted small">Correo: ${emailLabel}</div>
                            <div class="text-muted small">UID: ${participant.userId}</div>
                            <div class="text-muted small">Predicciones: ${participant.count}</div>
                            ${lastUpdate ? `<div class="text-muted small">Ultimo envio: ${lastUpdate}</div>` : ''}
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-danger btn-sm" data-action="delete-participant" data-user-id="${participant.userId}" data-user-label="${participant.playerName || participant.userId}">
                                Eliminar
                            </button>
                        </div>
                    `;
                    adminParticipantsList.appendChild(card);
                });

            } catch (error) {
                console.error("Error loading participants: ", error);
                adminParticipantsList.innerHTML = '<p class="text-center text-muted">No se pudieron cargar los participantes.</p>';
                setParticipantsMessage(`Error al cargar participantes: ${error.message}`, true);
            }
        }

        async function deleteParticipant(userId, label) {
            if (!userId) return;
            const safeLabel = label || userId;
            const confirmDelete = window.confirm(`Eliminar participante ${safeLabel}? Se borraran sus predicciones.`);
            if (!confirmDelete) return;

            setParticipantsMessage('Eliminando participante...', false);

            try {
                const predictionsRef = collection(db, 'predictions');
                const q = query(predictionsRef, where('userId', '==', userId));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    setParticipantsMessage('No se encontraron predicciones para este usuario.');
                    await loadParticipants();
                    return;
                }

                const deletions = [];
                snapshot.forEach(docSnap => {
                    const prediction = docSnap.data();
                    if (prediction.tournamentId !== TOURNAMENT_CONFIG.tournamentId) return;
                    deletions.push(deleteDoc(docSnap.ref));
                });

                if (deletions.length === 0) {
                    setParticipantsMessage('No hay predicciones para borrar en este torneo.');
                    await loadParticipants();
                    return;
                }

                await Promise.all(deletions);
                setParticipantsMessage('Participante eliminado y predicciones borradas.', false);
                await loadParticipants();
            } catch (error) {
                console.error("Error deleting participant: ", error);
                setParticipantsMessage(`Error al eliminar: ${error.message}`, true);
            }
        }

        if (refreshParticipantsButton) {
            refreshParticipantsButton.addEventListener('click', () => {
                loadParticipants();
            });
        }

        if (adminParticipantsList) {
            adminParticipantsList.addEventListener('click', (event) => {
                const button = event.target.closest('[data-action="delete-participant"]');
                if (!button) return;
                const userId = button.getAttribute('data-user-id');
                const label = button.getAttribute('data-user-label');
                deleteParticipant(userId, label);
            });
        }

        /**
         * Handle Sign In
         */
        signInButton.addEventListener('click', async (event) => {
            event.preventDefault();
            const email = userEmailInput.value.trim();
            const password = userPasswordInput.value.trim();

            if (!email || !password) {
                authMessageDiv.textContent = 'Please enter both email and password.';
                return;
            }

            try {
                authMessageDiv.textContent = 'Signing in...';
                authMessageDiv.style.color = 'inherit';
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('User signed in:', userCredential.user.email);
            } catch (error) {
                authMessageDiv.textContent = `Sign in failed: ${error.message}`;
                console.error('Sign in error:', error);
            }
        });

        /**
         * Handle Forgot Password
         */
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            const email = userEmailInput.value.trim();
            if (!email) {
                authMessageDiv.textContent = 'Please enter your email first.';
                return;
            }
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    authMessageDiv.textContent = 'Password reset email sent! Check your inbox.';
                    authMessageDiv.style.color = 'green';
                })
                .catch((error) => {
                    authMessageDiv.textContent = `Error: ${error.message}`;
                    authMessageDiv.style.color = 'red';
                });
        });

        /**
         * Handle Sign Out
         */
        signOutButton.addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    console.log('User signed out');
                })
                .catch((error) => {
                    console.error('Sign out error:', error);
                });
        });

        /**
         * Auth State Change Listener
         */
        function updateNavbarForUser(user) {
            const isAdmin = user && user.uid === ADMIN_UID;
            mountNavbar({
                activeKey: 'admin',
                showAdmin: isAdmin
            });
        }

        onAuthStateChanged(auth, async (user) => {
            updateNavbarForUser(user);
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                currentUserEmail = user.email;

                // Update UI for signed-in state
                loginRegisterFormDiv.style.display = 'none';
                userStatusDisplayDiv.style.display = 'block';
                userNameDisplay.textContent = user.email.split('@')[0];
                userEmailDisplay.textContent = user.email;

                // Show Admin Game Form if the user is the admin
                if (currentUserId === ADMIN_UID) {
                    console.log("Admin user detected, initializing admin panel...");
                    toggleAdminForm(true);
                    // Populate admin dropdowns and datalist when admin signs in
                    await initializeAdminDropdowns();
                    await loadParticipants();
                } else {
                    console.log("Non-admin user detected. Redirecting to index.html");
                    // Redirect non-admin users to index.html
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }

                console.log("User signed in:", user.email, "UID:", user.uid);

            } else {
                // User is signed out
                currentUserId = null;
                currentUserEmail = null;
                loginRegisterFormDiv.style.display = 'block';
                userStatusDisplayDiv.style.display = 'none';
                adminGameFormSection.style.display = 'none';
                authMessageDiv.textContent = '';
            }
        });

        // Listen for admin game addition events and refresh dropdowns
        window.addEventListener('adminGameAdded', async () => {
            console.log("Admin game added event received, refreshing dropdowns...");
            await initializeAdminDropdowns();
        });
        window.addEventListener('adminGameUpdated', async () => {
            console.log("Admin game updated event received, refreshing dropdowns...");
            await initializeAdminDropdowns();
        });

        console.log("Admin panel script loaded successfully");
    </script>
</body>

</html>

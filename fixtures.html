<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - Mundial 2026</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles_final.css">
    <link rel="icon" href="./css/icon/favicon-ball.ico" />
</head>
<body class="bg-dark text-white">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="index.html">WC26</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Inicio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="leaderboard.html">Tabla</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="game_weeks.html">Fases</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="fixtures.html">Calendario <span class="sr-only">(current)</span></a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container py-4">
        <section class="section-hero">
            <div class="section-hero-content">
                <span class="hero-badge">MUNDIAL 2026</span>
                <h1 class="hero-title">Calendario completo</h1>
                <p class="hero-subtitle">Partidos ordenados por fecha y grupos para que no te pierdas nada.</p>
            </div>
        </section>
        <div id="sync-status-banner" class="text-center text-muted" style="margin-bottom: 16px; font-size: 0.85rem;"></div>

        <!-- Filter Selector -->
        <div id="fixtures-phase-selector" class="gameweek-selector text-center mb-4" style="display: none;">
            <h5 class="mb-3">Filtrar por grupo:</h5>
            <div id="fixtures-phase-buttons"></div>
        </div>

        <!-- Games List -->
        <div id="game-list" class="game-list">
            <p class="loading-message">Cargando partidos...</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { firebaseConfig } from "./js/firebase-config.js";
        import { createPhaseSelector, updatePhaseSelectorState } from "./js/ui-helpers.js";
        import { TOURNAMENT_CONFIG, resolveStageLabel } from "./js/tournament-config.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State
        let allGames = [];
        let selectedFilter = null;
        let allTeams = {};
        const statusLabelMap = {
            finished: 'Finalizado',
            live: 'En vivo',
            in_play: 'En vivo',
            upcoming: 'Próximo'
        };

        const gameListDiv = document.getElementById('game-list');
        const fixturesPhaseSelector = document.getElementById('fixtures-phase-selector');

        loadSyncStatus();

        // Load teams first
        async function loadTeams() {
            try {
                const teamsSnapshot = await getDocs(collection(db, 'teams'));
                allTeams = {};
                teamsSnapshot.forEach(doc => {
                    const team = doc.data();
                    allTeams[team.name] = team;
                });
            } catch (error) {
                console.error("Error loading teams: ", error);
            }
        }

        // Load all games
        async function loadGames() {
            gameListDiv.innerHTML = '<p class="loading-message">Cargando partidos...</p>';

            try {
                const gamesRef = collection(db, 'games');
                const q = query(
                    gamesRef,
                    where('tournamentId', '==', TOURNAMENT_CONFIG.tournamentId)
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    gameListDiv.innerHTML = '<p>No hay partidos.</p>';
                    return;
                }

                // Store all games
                allGames = [];
                snapshot.forEach(doc => {
                    allGames.push(doc.data());
                });
                allGames.sort((a, b) => {
                    const timeA = a.KickOffTime ? new Date(a.KickOffTime).getTime() : 0;
                    const timeB = b.KickOffTime ? new Date(b.KickOffTime).getTime() : 0;
                    return timeA - timeB;
                });

                // Build filter options (all, groups)
                const groupSet = new Set();
                allGames.forEach(game => {
                    const rawGroup = game.Group || game.group;
                    if (rawGroup) {
                        groupSet.add(String(rawGroup).toUpperCase());
                    }
                });

                const groupList = Array.from(groupSet).sort();
                const filterOptions = [
                    'ALL',
                    ...groupList.map(group => `GROUP-${group}`)
                ];

                // Show selector if multiple options
                if (filterOptions.length > 1) {
                    fixturesPhaseSelector.style.display = 'block';
                    // Default: show all games by date (closest first)
                    selectedFilter = 'ALL';
                    
                    createPhaseSelector(
                        filterOptions,
                        (filterKey) => {
                            selectedFilter = filterKey;
                            updatePhaseSelectorState('fixtures-phase-buttons', filterKey);
                            displayFilteredGames();
                        },
                        'fixtures-phase-buttons',
                        'ALL',
                        'fixturesPhaseSelector',
                        (filterKey) => {
                            if (filterKey === 'ALL') return 'Todos (más próximos primero)';
                            if (filterKey.startsWith('GROUP-')) return `Grupo ${filterKey.split('-')[1]}`;
                            return filterKey;
                        }
                    );
                } else if (filterOptions.length === 1) {
                    fixturesPhaseSelector.style.display = 'none';
                    selectedFilter = filterOptions[0];
                }

                displayFilteredGames();

            } catch (error) {
                console.error("Error loading games: ", error);
                gameListDiv.innerHTML = '<p>Error al cargar partidos. Intenta nuevamente.</p>';
            }
        }

        // Display filtered games
        function displayFilteredGames() {
            const filteredGames = selectedFilter && selectedFilter !== 'ALL'
                ? allGames.filter(game => {
                    if (selectedFilter.startsWith('GROUP-')) {
                        const group = selectedFilter.split('-')[1];
                        const gameStage = String(game.Stage || game.stage || '').toUpperCase();
                        const gameGroup = String(game.Group || game.group || '').toUpperCase();
                        return gameStage === 'GROUP' && gameGroup === group;
                    }
                    return true;
                })
                : allGames;

            if (filteredGames.length === 0) {
                gameListDiv.innerHTML = '<p class="text-center">No hay partidos para este filtro.</p>';
                return;
            }

            gameListDiv.innerHTML = '';

            filteredGames.forEach(game => {
                const homeTeamData = allTeams[game.HomeTeam] || {};
                const awayTeamData = allTeams[game.AwayTeam] || {};
                const homeLogoUrl = homeTeamData.logoUrl || '';
                const awayLogoUrl = awayTeamData.logoUrl || '';

                const statusValue = (game.Status || game.status || 'upcoming').toLowerCase();
                const statusClass = statusValue === 'in_play' ? 'live' : statusValue;
                const statusLabel = statusLabelMap[statusValue] || statusValue;
                let scoreDisplay = '';
                if (statusValue === 'finished') {
                    const homeScore = game.HomeScore !== null && game.HomeScore !== undefined ? game.HomeScore : '?';
                    const awayScore = game.AwayScore !== null && game.AwayScore !== undefined ? game.AwayScore : '?';
                    scoreDisplay = `<p><strong>Resultado:</strong> ${homeScore} - ${awayScore}</p>`;
                }

                let phaseLabel = resolveStageLabel(game);
                if ((game.Stage || game.stage) === 'GROUP' && (game.Group || game.group)) {
                    phaseLabel = `Grupo ${String(game.Group || game.group).toUpperCase()}`;
                }

                const gameCard = document.createElement('div');
                gameCard.classList.add('app-card', 'game-card');

                const kickoffDate = game.KickOffTime ? new Date(game.KickOffTime) : null;
                const kickoffLabel = kickoffDate && !Number.isNaN(kickoffDate.getTime())
                    ? kickoffDate.toLocaleString([], { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' })
                    : 'Sin horario';

                gameCard.innerHTML = `
                    <div class="teams-row">
                        <div class="team">
                            ${homeLogoUrl ? `<img src="${homeLogoUrl}" alt="${game.HomeTeam} Logo" class="team-logo">` : '<div class="team-logo-placeholder">-</div>'}
                            <p class="team-name">${game.HomeTeam}</p>
                        </div>
                        <div class="vs-separator">vs</div>
                        <div class="team">
                            ${awayLogoUrl ? `<img src="${awayLogoUrl}" alt="${game.AwayTeam} Logo" class="team-logo">` : '<div class="team-logo-placeholder">-</div>'}
                            <p class="team-name">${game.AwayTeam}</p>
                        </div>
                    </div>
                    <p><strong>Fase:</strong> ${phaseLabel}</p>
                    <p><strong>Inicio:</strong> ${kickoffLabel}</p>
                    <p><strong>Estado:</strong> <span class="status ${statusClass}">${statusLabel}</span></p>
                    ${scoreDisplay}
                `;
                gameListDiv.appendChild(gameCard);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTeams();
            await loadGames();
        });

        async function loadSyncStatus() {
            const banner = document.getElementById('sync-status-banner');
            if (!banner) return;

            try {
                const statusRef = doc(db, 'sync_status', TOURNAMENT_CONFIG.tournamentId);
                const statusSnap = await getDoc(statusRef);
                const data = statusSnap.exists() ? statusSnap.data() : {};
                const lastSync = data.lastSuccessAt || data.lastSyncedAt || data.lastRunAt;
                const lastText = lastSync
                    ? (lastSync.toDate ? lastSync.toDate().toLocaleString() : new Date(lastSync).toLocaleString())
                    : 'N/A';
                banner.textContent = `Actualización automática post-partido (no en vivo). Última sync: ${lastText}`;
            } catch (error) {
                banner.textContent = 'Actualización automática post-partido (no en vivo).';
            }
        }
    </script>

</body>
</html>
